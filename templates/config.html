
<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1">
		<title>Team Configuration</title>
		<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
	</head>
	<body>
		<nav class="navbar">
			<div class="container nav-inner">
				<a class="brand" href="{{ url_for('index') }}">ScoringEngine</a>
				<div class="nav-cycle" id="navCycle">Cycle #{{ grading_cycle_count }}</div>
						<div class="nav-links">
							<a href="{{ url_for('index') }}">Status</a>
							<a href="{{ url_for('leaderboard') }}">Leaderboard</a>
							<a class="active" href="{{ url_for('config') }}">Team Config</a>
							{% if session.get('logged_in') %}
								<a href="{{ url_for('logout') }}">Logout</a>
							{% else %}
								<a href="{{ url_for('login') }}">Login</a>
							{% endif %}
						</div>
			</div>
		</nav>

		<main class="container">
			<div class="page-header">
				<h1>Team Configuration</h1>
				<div class="btn-group">
					<a class="btn btn-secondary" href="{{ url_for('index') }}">Status Matrix</a>
					<a class="btn btn-outline" href="{{ url_for('leaderboard') }}">View Leaderboard</a>
				</div>
			</div>

			<p class="subtle mb-3">Update the SSH credentials and ports for your team's systems. Changes are disabled while grading is running.</p>

			<div id="gradingBanner" class="alert warn mb-3" style="display:none;">
				Grading is currently in progress. Editing is temporarily disabled.
			</div>

			<form id="configForm">
				<div class="grid two" id="systemsGrid">
					<!-- System cards will be dynamically generated here -->
				</div>
				<div class="actions">
					<button type="submit" id="saveBtn" class="btn btn-primary">Save Changes</button>
					<span class="status" id="saveStatus"></span>
				</div>
			</form>

			<div class="mt-3">
				<h2 class="mb-2">Current Check Status</h2>
				<p class="subtle">Cells show the last result for each check. Hover to see the full error message.</p>
				<div class="card mt-2">
					<div class="card-body table-responsive">
						<div id="statusTableContainer"></div>
					</div>
				</div>
			</div>
		</main>

		<script src="{{ url_for('static', filename='error_banner.js') }}"></script>
		<script>
		  async function refreshCycle() {
			try {
			  const r = await fetch('/api/grading-status');
			  if (!r.ok) return;
			  const data = await r.json();
			  const el = document.getElementById('navCycle');
			  if (el && typeof data.cycle === 'number') {
				el.textContent = `Cycle #${data.cycle}`;
			  }
			} catch {}
		  }
		  refreshCycle();
		  setInterval(refreshCycle, 5000);
		</script>
    <script>
      try {
        const socket = io();
        socket.on('gradingCycle', (payload) => {
          const el = document.getElementById('navCycle');
          if (el && payload && typeof payload.cycle === 'number') {
            el.textContent = `Cycle #${payload.cycle}`;
          }
        });
      } catch {}
    </script>
		<script>
			const form = document.getElementById('configForm');
			const saveBtn = document.getElementById('saveBtn');
			const saveStatus = document.getElementById('saveStatus');
			const gradingBanner = document.getElementById('gradingBanner');
			const systemsGrid = document.getElementById('systemsGrid');

			let currentTeam = null;
			let systemsList = [];
			let servicesConfig = {};

			async function fetchSystems() {
				const res = await fetch('/api/systems');
				if (!res.ok) throw new Error('Failed to load systems config');
				return res.json();
			}

			async function fetchConfigs() {
				const res = await fetch('/api/team-configs');
				if (!res.ok) throw new Error('Failed to load team configs');
				return res.json();
			}

			async function fetchGradingStatus() {
				try {
					const res = await fetch('/api/grading-status');
					if (!res.ok) return { isGrading: false };
					return res.json();
				} catch { return { isGrading: false }; }
			}

			function setFormDisabled(disabled) {
				form.querySelectorAll('input, button').forEach(el => {
					el.disabled = disabled;
				});
				gradingBanner.style.display = disabled ? 'block' : 'none';
				form.classList.toggle('disabled', disabled);
			}

			function buildSystemCards(systems, services) {
				systemsGrid.innerHTML = '';
				systemsList = systems;
				servicesConfig = services;

				systems.forEach((system, index) => {
					const card = document.createElement('div');
					card.className = 'card';
					
					const cardHeader = document.createElement('div');
					cardHeader.className = 'card-header';
					cardHeader.textContent = index === 0 ? 'Your Team' : '\u00A0';
					card.appendChild(cardHeader);
					
					const cardBody = document.createElement('div');
					cardBody.className = 'card-body';
					
					const title = document.createElement('h3');
					title.className = 'mb-2';
					title.textContent = system.display_name || system.name;
					cardBody.appendChild(title);
					
					// Add fieldsets for each service type the system has
					const systemServices = system.services || [];
					
					if (systemServices.includes('ssh')) {
						const sshFieldset = document.createElement('fieldset');
						sshFieldset.className = 'mb-2';
						const sshLegend = document.createElement('legend');
						sshLegend.textContent = 'SSH';
						sshFieldset.appendChild(sshLegend);
						
						// Username
						const userLabel = document.createElement('label');
						userLabel.setAttribute('for', `${system.name}_ssh_username`);
						userLabel.textContent = 'Username';
						sshFieldset.appendChild(userLabel);
						const userInput = document.createElement('input');
						userInput.id = `${system.name}_ssh_username`;
						userInput.name = `${system.name}.ssh.username`;
						userInput.type = 'text';
						userInput.required = true;
						sshFieldset.appendChild(userInput);
						
						// Password
						const passLabel = document.createElement('label');
						passLabel.setAttribute('for', `${system.name}_ssh_password`);
						passLabel.textContent = 'Password';
						sshFieldset.appendChild(passLabel);
						const passInput = document.createElement('input');
						passInput.id = `${system.name}_ssh_password`;
						passInput.name = `${system.name}.ssh.password`;
						passInput.type = 'text';
						passInput.required = true;
						sshFieldset.appendChild(passInput);
						
						// Port
						const portLabel = document.createElement('label');
						portLabel.setAttribute('for', `${system.name}_ssh_port`);
						portLabel.textContent = 'Port';
						sshFieldset.appendChild(portLabel);
						const portInput = document.createElement('input');
						portInput.id = `${system.name}_ssh_port`;
						portInput.name = `${system.name}.ssh.port`;
						portInput.type = 'number';
						portInput.min = '1';
						portInput.max = '65535';
						portInput.required = true;
						sshFieldset.appendChild(portInput);
						
						cardBody.appendChild(sshFieldset);
					}
					
					if (systemServices.includes('web')) {
						const webFieldset = document.createElement('fieldset');
						const webLegend = document.createElement('legend');
						webLegend.textContent = 'Web';
						webFieldset.appendChild(webLegend);
						
						const webPortLabel = document.createElement('label');
						webPortLabel.setAttribute('for', `${system.name}_web_port`);
						webPortLabel.textContent = 'Port';
						webFieldset.appendChild(webPortLabel);
						const webPortInput = document.createElement('input');
						webPortInput.id = `${system.name}_web_port`;
						webPortInput.name = `${system.name}.web.port`;
						webPortInput.type = 'number';
						webPortInput.min = '1';
						webPortInput.max = '65535';
						webPortInput.required = true;
						webFieldset.appendChild(webPortInput);
						
						cardBody.appendChild(webFieldset);
					}
					
					if (systemServices.includes('active_directory')) {
						const adFieldset = document.createElement('fieldset');
						const adLegend = document.createElement('legend');
						adLegend.textContent = 'Active Directory';
						adFieldset.appendChild(adLegend);
						
						// Username
						const adUserLabel = document.createElement('label');
						adUserLabel.setAttribute('for', `${system.name}_ad_username`);
						adUserLabel.textContent = 'Username';
						adFieldset.appendChild(adUserLabel);
						const adUserInput = document.createElement('input');
						adUserInput.id = `${system.name}_ad_username`;
						adUserInput.name = `${system.name}.active_directory.username`;
						adUserInput.type = 'text';
						adUserInput.required = true;
						adFieldset.appendChild(adUserInput);
						
						// Password
						const adPassLabel = document.createElement('label');
						adPassLabel.setAttribute('for', `${system.name}_ad_password`);
						adPassLabel.textContent = 'Password';
						adFieldset.appendChild(adPassLabel);
						const adPassInput = document.createElement('input');
						adPassInput.id = `${system.name}_ad_password`;
						adPassInput.name = `${system.name}.active_directory.password`;
						adPassInput.type = 'text';
						adPassInput.required = true;
						adFieldset.appendChild(adPassInput);
						
						// Domain
						const adDomainLabel = document.createElement('label');
						adDomainLabel.setAttribute('for', `${system.name}_ad_domain`);
						adDomainLabel.textContent = 'Domain';
						adFieldset.appendChild(adDomainLabel);
						const adDomainInput = document.createElement('input');
						adDomainInput.id = `${system.name}_ad_domain`;
						adDomainInput.name = `${system.name}.active_directory.domain`;
						adDomainInput.type = 'text';
						adDomainInput.required = true;
						adFieldset.appendChild(adDomainInput);
						
						cardBody.appendChild(adFieldset);
					}
					
					card.appendChild(cardBody);
					systemsGrid.appendChild(card);
				});
			}

			function applyConfigs(cfg) {
				// cfg should have one key: team1 or team2, etc
				const teamKey = Object.keys(cfg)[0];
				if (!teamKey) return;
				currentTeam = teamKey;
				
				const teamData = cfg[teamKey] || {};
				
				systemsList.forEach(system => {
					const systemName = system.name;
					const systemData = teamData[systemName] || {};
					
					// Apply SSH config if system has SSH service
					if (system.services.includes('ssh')) {
						const sshData = systemData.ssh || {};
						const usernameEl = document.getElementById(`${systemName}_ssh_username`);
						const passwordEl = document.getElementById(`${systemName}_ssh_password`);
						const portEl = document.getElementById(`${systemName}_ssh_port`);
						
						if (usernameEl) usernameEl.value = sshData.username || '';
						if (passwordEl) passwordEl.value = sshData.password || '';
						if (portEl) portEl.value = sshData.port ?? 22;
					}
					
					// Apply Web config if system has Web service
					if (system.services.includes('web')) {
						const webData = systemData.web || {};
						const webPortEl = document.getElementById(`${systemName}_web_port`);
						if (webPortEl) webPortEl.value = webData.port ?? 80;
					}
					
					// Apply Active Directory config if system has Active Directory service
					if (system.services.includes('active_directory')) {
						const adData = systemData.active_directory || {};
						const adUsernameEl = document.getElementById(`${systemName}_ad_username`);
						const adPasswordEl = document.getElementById(`${systemName}_ad_password`);
						const adDomainEl = document.getElementById(`${systemName}_ad_domain`);
						
						if (adUsernameEl) adUsernameEl.value = adData.username || '';
						if (adPasswordEl) adPasswordEl.value = adData.password || '';
						if (adDomainEl) adDomainEl.value = adData.domain || '';
					}
				});
			}

			function readForm() {
				if (!currentTeam) return {};
				const result = { [currentTeam]: {} };
				
				systemsList.forEach(system => {
					const systemName = system.name;
					result[currentTeam][systemName] = {};
					
					// Read SSH config if system has SSH service
					if (system.services.includes('ssh')) {
						const username = document.getElementById(`${systemName}_ssh_username`)?.value;
						const password = document.getElementById(`${systemName}_ssh_password`)?.value;
						const port = document.getElementById(`${systemName}_ssh_port`)?.value;
						
						result[currentTeam][systemName].ssh = {
							username: username,
							password: password,
							port: parseInt(port, 10)
						};
					}
					
					// Read Web config if system has Web service
					if (system.services.includes('web')) {
						const webPort = document.getElementById(`${systemName}_web_port`)?.value;
						result[currentTeam][systemName].web = {
							port: parseInt(webPort, 10)
						};
					}
					
					// Read Active Directory config if system has Active Directory service
					if (system.services.includes('active_directory')) {
						const adUsername = document.getElementById(`${systemName}_ad_username`)?.value;
						const adPassword = document.getElementById(`${systemName}_ad_password`)?.value;
						const adDomain = document.getElementById(`${systemName}_ad_domain`)?.value;
						
						result[currentTeam][systemName].active_directory = {
							username: adUsername,
							password: adPassword,
							domain: adDomain
						};
					}
				});
				
				return result;
			}

			async function init() {
				// Load systems first to build the form
				const systemsData = await fetchSystems();
				buildSystemCards(systemsData.systems, systemsData.services);
				
				// Then load configs and status
				const [cfg, status] = await Promise.all([fetchConfigs(), fetchGradingStatus()]);
				applyConfigs(cfg);
				setFormDisabled(Boolean(status.isGrading));
			}

			form.addEventListener('submit', async (e) => {
				e.preventDefault();
				saveStatus.textContent = '';
				saveStatus.className = 'status';
				saveBtn.disabled = true;
				try {
					const payload = readForm();
					const res = await fetch('/api/team-configs', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(payload)
					});
					if (res.status === 409) {
						const body = await res.json();
						saveStatus.textContent = body.error || 'Grading in progress; try again later.';
						saveStatus.classList.add('error');
					} else if (!res.ok) {
						const body = await res.json().catch(() => ({}));
						saveStatus.textContent = body.error || 'Failed to save changes.';
						saveStatus.classList.add('error');
					} else {
						saveStatus.textContent = 'Saved!';
						saveStatus.classList.add('success');
					}
				} catch (err) {
					saveStatus.textContent = 'Error saving changes.';
					saveStatus.classList.add('error');
				} finally {
					saveBtn.disabled = false;
					// Refresh grading status just in case
					const status = await fetchGradingStatus();
					setFormDisabled(Boolean(status.isGrading));
				}
			});

			// Poll grading status to disable form while running
			setInterval(async () => {
				const status = await fetchGradingStatus();
				setFormDisabled(Boolean(status.isGrading));
			}, 5000);

			// Build and update a status table for this team
			function buildStatusTable(teamKey, scores) {
				const container = document.getElementById('statusTableContainer');
				container.innerHTML = '';
				const table = document.createElement('table');
				const thead = document.createElement('thead');
				const trh = document.createElement('tr');
				
				// Build header: System + service types (without system names in header)
				const headers = ['System'];
				// Get unique service types from all systems
				const serviceTypes = new Set();
				systemsList.forEach(system => {
					system.services.forEach(service => serviceTypes.add(service));
				});
				
				// Add service type headers
				Array.from(serviceTypes).forEach(serviceName => {
					const serviceConfig = servicesConfig[serviceName] || {};
					headers.push(serviceConfig.display_name || serviceName);
				});
				
				headers.forEach(h => { 
					const th = document.createElement('th'); 
					th.textContent = h; 
					trh.appendChild(th); 
				});
				thead.appendChild(trh);
				table.appendChild(thead);
				
				const tbody = document.createElement('tbody');
				systemsList.forEach(system => {
					const tr = document.createElement('tr');
					const sysTh = document.createElement('th'); 
					sysTh.textContent = system.display_name || system.name; 
					tr.appendChild(sysTh);
					
					// For each service type, check if this system has it
					Array.from(serviceTypes).forEach(serviceName => {
						const td = document.createElement('td');
						
						if (system.services.includes(serviceName)) {
							const key = `${system.name}${serviceName}`; // e.g., ubuntu1ping
							const svcObj = (scores[teamKey] || {})[key];
							const errStr = String(svcObj ? svcObj.error : 'Not tested');
							if (errStr === 'Success') {
								td.className = 'ok';
								td.textContent = 'Success';
							} else if (errStr === 'Not tested') {
								td.className = 'unknown';
								td.textContent = 'Not tested';
							} else {
								td.className = 'fail';
								td.textContent = 'Fail';
								const detail = document.createElement('span');
								detail.className = 'error-detail';
								const snippet = errStr.slice(0, 120);
								detail.textContent = snippet + (errStr.length > 120 ? '…' : '');
								td.appendChild(detail);
								td.title = errStr;
							}
						} else {
							// System doesn't have this service
							td.className = 'unknown';
							td.textContent = 'N/A';
						}
						tr.appendChild(td);
					});
					tbody.appendChild(tr);
				});
				table.appendChild(tbody);
				container.appendChild(table);
			}

			async function fetchTeamScores() {
				try {
					const r = await fetch('/api/team-scores');
					if (!r.ok) {
						if (window.AppNotice) AppNotice.warn('Could not load team scores.');
						return {};
					}
					return r.json();
				} catch (e) {
					console.warn('fetchTeamScores failed', e);
					if (window.AppNotice) AppNotice.warn('Network error while loading team scores.');
					return {};
				}
			}

			async function initStatus() {
				try {
					const teamKey = currentTeam;
					if (!teamKey) return;
					const data = await fetchTeamScores();
					buildStatusTable(teamKey, data);
				} catch {}
			}

			// Kick off UI
			init().then(initStatus).catch(err => {
				saveStatus.textContent = 'Failed to load configs. Please refresh.';
				saveStatus.classList.add('error');
				if (window.AppNotice) AppNotice.error('Failed to load configuration.');
			});

			// Live updates via Socket.IO
			(function(){
				const s = document.createElement('script'); s.src = 'https://cdn.socket.io/4.7.2/socket.io.min.js'; s.onload = () => {
					const socket = io();
					socket.on('scores', (scores) => {
						if (!currentTeam) return;
						buildStatusTable(currentTeam, scores);
					});
					socket.on('disconnect', () => {
						if (window.AppNotice) AppNotice.warn('Disconnected from live updates. Changes are still saved.');
					});
				}; document.body.appendChild(s);
			})();
		</script>
	</body>
 </html>
